# Security Architecture & Flow Diagrams

## ğŸ—ï¸ Overall System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Client Application                       â”‚
â”‚                    (Web/Mobile/Postman/etc.)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ HTTP Requests
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Eureka Server (8761)                        â”‚
â”‚                     Service Discovery                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Auth Service      â”‚  â”‚   Other Microservices          â”‚
        â”‚   Port: 8081       â”‚  â”‚   (8082-8087)                  â”‚
        â”‚                    â”‚  â”‚                                 â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚ â”‚ User           â”‚ â”‚  â”‚ â”‚ Common Security         â”‚  â”‚
        â”‚ â”‚ Management     â”‚ â”‚  â”‚ â”‚ Library                 â”‚  â”‚
        â”‚ â”‚                â”‚ â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
        â”‚ â”‚ Role/          â”‚ â”‚  â”‚ â”‚ â”‚ JwtAuth Filter     â”‚  â”‚  â”‚
        â”‚ â”‚ Permission     â”‚ â”‚  â”‚ â”‚ â”‚ AuthServiceClient  â”‚  â”‚  â”‚
        â”‚ â”‚ Management     â”‚ â”‚  â”‚ â”‚ â”‚ SecurityUtils      â”‚  â”‚  â”‚
        â”‚ â”‚                â”‚ â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                    â”‚  â”‚                                 â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚ â”‚ JWT Token      â”‚ â”‚  â”‚ â”‚ Business Logic          â”‚  â”‚
        â”‚ â”‚ Generation     â”‚â—„â”€â”¼â”€â”€â”¤ â”‚ (Patient, Appointment,  â”‚  â”‚
        â”‚ â”‚ & Validation   â”‚ â”‚  â”‚ â”‚  Medical Records, etc.) â”‚  â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                           â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   PostgreSQL         â”‚
                  â”‚   Database           â”‚
                  â”‚   - analytics_db     â”‚
                  â”‚   - patient_db       â”‚
                  â”‚   - appointment_db   â”‚
                  â”‚   - etc.             â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Authentication Flow

### 1. User Registration & Login

```
â”Œâ”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”‚                  â”‚ Auth Service â”‚                â”‚ Database â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚                             â”‚                             â”‚
   â”‚ POST /api/auth/register     â”‚                             â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                             â”‚
   â”‚ {username, email, password} â”‚                             â”‚
   â”‚                             â”‚                             â”‚
   â”‚                             â”‚ Hash password (BCrypt)      â”‚
   â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
   â”‚                             â”‚         â”‚                   â”‚
   â”‚                             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
   â”‚                             â”‚                             â”‚
   â”‚                             â”‚ Save user with roles        â”‚
   â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                             â”‚                             â”‚
   â”‚                             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                             â”‚ User saved                  â”‚
   â”‚                             â”‚                             â”‚
   â”‚                             â”‚ Generate JWT token          â”‚
   â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
   â”‚                             â”‚         â”‚                   â”‚
   â”‚                             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
   â”‚                             â”‚                             â”‚
   â”‚ 201 Created                 â”‚                             â”‚
   â”‚ {token, user details}       â”‚                             â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
   â”‚                             â”‚                             â”‚
   â”‚                             â”‚                             â”‚
   â”‚ POST /api/auth/login        â”‚                             â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                             â”‚
   â”‚ {username, password}        â”‚                             â”‚
   â”‚                             â”‚                             â”‚
   â”‚                             â”‚ Fetch user by username      â”‚
   â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                             â”‚                             â”‚
   â”‚                             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                             â”‚ User with roles/permissions â”‚
   â”‚                             â”‚                             â”‚
   â”‚                             â”‚ Verify password             â”‚
   â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
   â”‚                             â”‚         â”‚                   â”‚
   â”‚                             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
   â”‚                             â”‚                             â”‚
   â”‚                             â”‚ Generate JWT token          â”‚
   â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
   â”‚                             â”‚         â”‚                   â”‚
   â”‚                             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
   â”‚                             â”‚                             â”‚
   â”‚ 200 OK                      â”‚                             â”‚
   â”‚ {token, refreshToken, user} â”‚                             â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
   â”‚                             â”‚                             â”‚
```

### 2. Accessing Protected Resources

```
â”Œâ”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”‚         â”‚   Patient   â”‚         â”‚ Auth Service â”‚         â”‚ Database â”‚
â”‚      â”‚         â”‚   Service   â”‚         â”‚              â”‚         â”‚          â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚                    â”‚                       â”‚                      â”‚
   â”‚ GET /api/patients/1                       â”‚                      â”‚
   â”‚ Authorization: Bearer <token>             â”‚                      â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                       â”‚                      â”‚
   â”‚                    â”‚                       â”‚                      â”‚
   â”‚                    â”‚ Extract JWT token     â”‚                      â”‚
   â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                      â”‚
   â”‚                    â”‚        â”‚              â”‚                      â”‚
   â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                      â”‚
   â”‚                    â”‚                       â”‚                      â”‚
   â”‚                    â”‚ POST /api/auth/validate-header             â”‚
   â”‚                    â”‚ Authorization: Bearer <token>              â”‚
   â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
   â”‚                    â”‚                       â”‚                      â”‚
   â”‚                    â”‚                       â”‚ Verify JWT signature â”‚
   â”‚                    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
   â”‚                    â”‚                       â”‚         â”‚            â”‚
   â”‚                    â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
   â”‚                    â”‚                       â”‚                      â”‚
   â”‚                    â”‚                       â”‚ Check expiration     â”‚
   â”‚                    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
   â”‚                    â”‚                       â”‚         â”‚            â”‚
   â”‚                    â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
   â”‚                    â”‚                       â”‚                      â”‚
   â”‚                    â”‚                       â”‚ Extract user details â”‚
   â”‚                    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
   â”‚                    â”‚                       â”‚         â”‚            â”‚
   â”‚                    â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
   â”‚                    â”‚                       â”‚                      â”‚
   â”‚                    â”‚ 200 OK                â”‚                      â”‚
   â”‚                    â”‚ {valid:true, userId,  â”‚                      â”‚
   â”‚                    â”‚  roles, permissions}  â”‚                      â”‚
   â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
   â”‚                    â”‚                       â”‚                      â”‚
   â”‚                    â”‚ Set SecurityContext   â”‚                      â”‚
   â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                      â”‚
   â”‚                    â”‚        â”‚              â”‚                      â”‚
   â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                      â”‚
   â”‚                    â”‚                       â”‚                      â”‚
   â”‚                    â”‚ Check permissions     â”‚                      â”‚
   â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                      â”‚
   â”‚                    â”‚        â”‚              â”‚                      â”‚
   â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                      â”‚
   â”‚                    â”‚                       â”‚                      â”‚
   â”‚                    â”‚ Fetch patient from DB â”‚                      â”‚
   â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                    â”‚                       â”‚                      â”‚
   â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                    â”‚ Patient data          â”‚                      â”‚
   â”‚                    â”‚                       â”‚                      â”‚
   â”‚ 200 OK             â”‚                       â”‚                      â”‚
   â”‚ {patient data}     â”‚                       â”‚                      â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                      â”‚
   â”‚                    â”‚                       â”‚                      â”‚
```

### 3. Permission Denied Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”‚         â”‚   Service   â”‚         â”‚ Auth Service â”‚
â”‚      â”‚         â”‚             â”‚         â”‚              â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚                    â”‚                       â”‚
   â”‚ DELETE /api/patients/1                    â”‚
   â”‚ Authorization: Bearer <patient_token>     â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                       â”‚
   â”‚                    â”‚                       â”‚
   â”‚                    â”‚ Validate token        â”‚
   â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                    â”‚                       â”‚
   â”‚                    â”‚ Token valid:          â”‚
   â”‚                    â”‚ roles: [ROLE_PATIENT] â”‚
   â”‚                    â”‚ permissions: [READ]   â”‚
   â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                    â”‚                       â”‚
   â”‚                    â”‚ Check @RequirePermissionâ”‚
   â”‚                    â”‚ (PATIENT_DELETE)      â”‚
   â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
   â”‚                    â”‚        â”‚              â”‚
   â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
   â”‚                    â”‚ Permission denied!    â”‚
   â”‚                    â”‚                       â”‚
   â”‚ 403 Forbidden      â”‚                       â”‚
   â”‚ {success: false,   â”‚                       â”‚
   â”‚  message: "Access  â”‚                       â”‚
   â”‚  Denied"}          â”‚                       â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
   â”‚                    â”‚                       â”‚
```

## ğŸ”„ Token Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Token Lifecycle                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. GENERATION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ User logs in                                  â”‚
   â”‚  â†“                                            â”‚
   â”‚ Auth Service validates credentials            â”‚
   â”‚  â†“                                            â”‚
   â”‚ Generate JWT with user info:                 â”‚
   â”‚  - userId                                     â”‚
   â”‚  - username, email                            â”‚
   â”‚  - userType                                   â”‚
   â”‚  - roles                                      â”‚
   â”‚  - expiration: now + 24 hours                 â”‚
   â”‚  â†“                                            â”‚
   â”‚ Sign with secret key (HMAC-SHA256)           â”‚
   â”‚  â†“                                            â”‚
   â”‚ Return token to client                        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. STORAGE (Client-Side)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Client stores token:                          â”‚
   â”‚  - localStorage (Web)                         â”‚
   â”‚  - Secure storage (Mobile)                    â”‚
   â”‚  - Memory (Most secure but temporary)         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. USAGE
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ For each API request:                         â”‚
   â”‚  â†“                                            â”‚
   â”‚ Client includes token in header:              â”‚
   â”‚ Authorization: Bearer <token>                 â”‚
   â”‚  â†“                                            â”‚
   â”‚ Service extracts token                        â”‚
   â”‚  â†“                                            â”‚
   â”‚ Service validates token with Auth Service     â”‚
   â”‚  â†“                                            â”‚
   â”‚ Service processes request if valid            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. VALIDATION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Auth Service validates token:                 â”‚
   â”‚  â†“                                            â”‚
   â”‚ 1. Verify signature                           â”‚
   â”‚ 2. Check expiration                           â”‚
   â”‚ 3. Extract user details                       â”‚
   â”‚ 4. Verify user still exists/active            â”‚
   â”‚  â†“                                            â”‚
   â”‚ Return validation result + user details       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

5. EXPIRATION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Token expires after 24 hours                  â”‚
   â”‚  â†“                                            â”‚
   â”‚ Client receives 401 Unauthorized              â”‚
   â”‚  â†“                                            â”‚
   â”‚ Client uses refresh token (if available)      â”‚
   â”‚  OR                                           â”‚
   â”‚ Client redirects to login                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

6. REFRESH (Optional)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Client sends refresh token                    â”‚
   â”‚  â†“                                            â”‚
   â”‚ Auth Service validates refresh token          â”‚
   â”‚  â†“                                            â”‚
   â”‚ Generate new access token                     â”‚
   â”‚  â†“                                            â”‚
   â”‚ Return new token to client                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ Component Interaction

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Common Security Library                      â”‚
â”‚  (Shared by all microservices except Auth Service)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚              â”‚              â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ JwtAuth Filter    â”‚  â”‚ Auth Client â”‚  â”‚SecurityUtils â”‚
     â”‚ - Intercepts      â”‚  â”‚ - Calls     â”‚  â”‚- Get current â”‚
     â”‚   requests        â”‚  â”‚   Auth      â”‚  â”‚  user        â”‚
     â”‚ - Extracts token  â”‚  â”‚   Service   â”‚  â”‚- Check roles â”‚
     â”‚ - Sets security   â”‚  â”‚ - Validates â”‚  â”‚- Check perms â”‚
     â”‚   context         â”‚  â”‚   tokens    â”‚  â”‚              â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                  â”‚                â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Spring Security        â”‚
              â”‚  SecurityContextHolder  â”‚
              â”‚  - Stores UserPrincipal â”‚
              â”‚  - Thread-local storage â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Permission Check Flow

```
Request comes in
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JwtAuth Filter      â”‚
â”‚ - Extract token     â”‚
â”‚ - Validate with     â”‚
â”‚   Auth Service      â”‚
â”‚ - Set SecurityContextâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Controller Method   â”‚
â”‚ @RequirePermission  â”‚
â”‚ (PATIENT_READ)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Permission Aspect   â”‚
â”‚ - Get UserPrincipal â”‚
â”‚ - Check if user has â”‚
â”‚   required permissionâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
     â”‚           â”‚
  YESâ”‚           â”‚NO
     â”‚           â”‚
     â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Proceed â”‚  â”‚ Throw Access â”‚
â”‚ to      â”‚  â”‚ Denied       â”‚
â”‚ method  â”‚  â”‚ Exception    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚
     â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Businessâ”‚  â”‚ Return 403   â”‚
â”‚ Logic   â”‚  â”‚ Forbidden    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”’ Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Application Security Layers                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 1: Network Security
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ - HTTPS/TLS encryption                                        â”‚
â”‚ - Firewall rules                                              â”‚
â”‚ - VPN/Network isolation                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
Layer 2: API Gateway (Future)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ - Rate limiting                                               â”‚
â”‚ - Request validation                                          â”‚
â”‚ - Centralized authentication                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
Layer 3: Service-Level Security (Current Implementation)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ - JWT Authentication (JwtAuthenticationFilter)                â”‚
â”‚ - Token validation with Auth Service                          â”‚
â”‚ - Spring Security configuration                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
Layer 4: Method-Level Security
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ - @RequirePermission annotations                              â”‚
â”‚ - @PreAuthorize annotations                                   â”‚
â”‚ - Permission aspects                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
Layer 5: Business Logic Security
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ - Ownership validation (SecurityUtils.isOwner())              â”‚
â”‚ - Resource-specific access control                            â”‚
â”‚ - Data filtering based on user role                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
Layer 6: Data Security
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ - Database access control                                     â”‚
â”‚ - Row-level security                                          â”‚
â”‚ - Audit logging                                               â”‚
â”‚ - Data encryption at rest                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ Summary

This architecture provides:

1. **Centralized Authentication** - Single Auth Service for all microservices
2. **Distributed Authorization** - Each service validates tokens independently
3. **Flexible Permission System** - Granular RBAC with custom permissions
4. **High Availability** - Services continue working if Auth Service is temporarily down (via Feign fallback)
5. **Easy Integration** - Common Security Library makes integration simple
6. **Production Ready** - Includes proper error handling, logging, and monitoring

The system is designed to be:
- âœ… **Secure** - JWT tokens, encrypted passwords, permission checks
- âœ… **Scalable** - Stateless authentication, distributed validation
- âœ… **Maintainable** - Shared library, consistent patterns
- âœ… **Testable** - Clear separation of concerns, mockable components
- âœ… **Observable** - Comprehensive logging and health checks