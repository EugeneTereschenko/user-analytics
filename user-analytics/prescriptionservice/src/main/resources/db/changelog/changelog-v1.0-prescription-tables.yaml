databaseChangeLog:
  # Create prescriptions table
  - changeSet:
      id: 1
      author: healthcare-system
      changes:
        - createTable:
            tableName: prescriptions
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: prescription_number
                  type: VARCHAR(50)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: patient_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: doctor_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: medical_record_id
                  type: BIGINT
              - column:
                  name: appointment_id
                  type: BIGINT
              - column:
                  name: prescription_date
                  type: DATE
                  constraints:
                    nullable: false
              - column:
                  name: valid_until
                  type: DATE
              - column:
                  name: status
                  type: VARCHAR(20)
                  defaultValue: ACTIVE
                  constraints:
                    nullable: false
              - column:
                  name: patient_name
                  type: VARCHAR(200)
              - column:
                  name: patient_date_of_birth
                  type: DATE
              - column:
                  name: doctor_name
                  type: VARCHAR(200)
              - column:
                  name: doctor_license
                  type: VARCHAR(50)
              - column:
                  name: pharmacy_name
                  type: VARCHAR(200)
              - column:
                  name: pharmacy_address
                  type: VARCHAR(500)
              - column:
                  name: diagnosis
                  type: VARCHAR(500)
              - column:
                  name: notes
                  type: TEXT
              - column:
                  name: is_refillable
                  type: BOOLEAN
                  defaultValueBoolean: true
              - column:
                  name: refills_allowed
                  type: INTEGER
                  defaultValueNumeric: 0
              - column:
                  name: refills_remaining
                  type: INTEGER
                  defaultValueNumeric: 0
              - column:
                  name: dispensed_at
                  type: TIMESTAMP
              - column:
                  name: dispensed_by
                  type: VARCHAR(200)
              - column:
                  name: created_at
                  type: TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: cancelled_at
                  type: TIMESTAMP
              - column:
                  name: cancellation_reason
                  type: VARCHAR(500)
              - column:
                  name: user_id
                  type: BIGINT

        - createIndex:
            indexName: idx_prescriptions_patient_id
            tableName: prescriptions
            columns:
              - column:
                  name: patient_id

        - createIndex:
            indexName: idx_prescriptions_doctor_id
            tableName: prescriptions
            columns:
              - column:
                  name: doctor_id

        - createIndex:
            indexName: idx_prescriptions_status
            tableName: prescriptions
            columns:
              - column:
                  name: status

        - createIndex:
            indexName: idx_prescriptions_prescription_date
            tableName: prescriptions
            columns:
              - column:
                  name: prescription_date

  # Create medications table
  - changeSet:
      id: 2
      author: healthcare-system
      changes:
        - createTable:
            tableName: medications
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: prescription_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: medication_name
                  type: VARCHAR(200)
                  constraints:
                    nullable: false
              - column:
                  name: generic_name
                  type: VARCHAR(200)
              - column:
                  name: drug_code
                  type: VARCHAR(50)
              - column:
                  name: dosage
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: dosage_form
                  type: VARCHAR(50)
              - column:
                  name: strength
                  type: VARCHAR(50)
              - column:
                  name: frequency
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: duration
                  type: VARCHAR(100)
              - column:
                  name: quantity
                  type: INTEGER
              - column:
                  name: unit
                  type: VARCHAR(50)
              - column:
                  name: route
                  type: VARCHAR(50)
              - column:
                  name: instructions
                  type: TEXT
              - column:
                  name: start_date
                  type: DATE
              - column:
                  name: end_date
                  type: DATE
              - column:
                  name: warnings
                  type: TEXT
              - column:
                  name: side_effects
                  type: TEXT
              - column:
                  name: is_generic_allowed
                  type: BOOLEAN
                  defaultValueBoolean: true
              - column:
                  name: is_controlled_substance
                  type: BOOLEAN
                  defaultValueBoolean: false
              - column:
                  name: priority
                  type: INTEGER
                  defaultValueNumeric: 1

        - addForeignKeyConstraint:
            baseTableName: medications
            baseColumnNames: prescription_id
            constraintName: fk_medications_prescription
            referencedTableName: prescriptions
            referencedColumnNames: id
            onDelete: CASCADE

        - createIndex:
            indexName: idx_medications_prescription_id
            tableName: medications
            columns:
              - column:
                  name: prescription_id