<div class="container-fluid py-4">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a routerLink="/dashboard">Dashboard</a></li>
      <li class="breadcrumb-item"><a routerLink="/billing/dashboard">Billing</a></li>
      <li class="breadcrumb-item active" aria-current="page">Invoices</li>
    </ol>
  </nav>

  <div class="row mb-4">
    <div class="col">
      <h2 class="mb-0">
        <i class="bi bi-receipt me-2"></i>Billing & Invoices
      </h2>
    </div>
    <div class="col-auto">
      <button class="btn btn-primary" routerLink="/billing/invoices/create">
        <i class="bi bi-plus-circle me-2"></i>New Invoice
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card border-primary shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-1">Total Outstanding</h6>
              <h3 class="mb-0 text-primary">${{ totalOutstanding | number:'1.2-2' }}</h3>
            </div>
            <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
              <i class="bi bi-currency-dollar fs-3 text-primary"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-danger shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-1">Overdue Invoices</h6>
              <h3 class="mb-0 text-danger">{{ overdueCount }}</h3>
            </div>
            <div class="bg-danger bg-opacity-10 p-3 rounded-circle">
              <i class="bi bi-exclamation-triangle fs-3 text-danger"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-success shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-1">Total Invoices</h6>
              <h3 class="mb-0 text-success">{{ totalElements }}</h3>
            </div>
            <div class="bg-success bg-opacity-10 p-3 rounded-circle">
              <i class="bi bi-file-earmark-text fs-3 text-success"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Search</label>
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input 
              type="text" 
              class="form-control" 
              placeholder="Search invoices..."
              [(ngModel)]="searchQuery"
              (keyup.enter)="searchInvoices()">
            <button class="btn btn-outline-primary" (click)="searchInvoices()">
              Search
            </button>
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Status Filter</label>
          <select 
            class="form-select" 
            [(ngModel)]="statusFilter"
            (change)="filterByStatus()">
            <option value="ALL">All Statuses</option>
            <option *ngFor="let status of invoiceStatuses" [value]="status">
              {{ status.replace('_', ' ') | titlecase }}
            </option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Patient ID</label>
          <input 
            type="number" 
            class="form-control" 
            placeholder="Patient ID"
            [(ngModel)]="patientIdFilter"
            (change)="filterByPatient()">
        </div>

        <div class="col-md-3">
          <label class="form-label">&nbsp;</label>
          <div class="d-grid gap-2 d-md-flex">
            <button class="btn btn-outline-secondary" (click)="loadInvoices(); loadStats()">
              <i class="bi bi-arrow-clockwise me-1"></i>Reset
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Alert -->
  <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ error }}
    <button type="button" class="btn-close" (click)="error = null"></button>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Invoices Table -->
  <div *ngIf="!isLoading" class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Invoice #</th>
              <th>Patient</th>
              <th>Date</th>
              <th>Due Date</th>
              <th>Total</th>
              <th>Paid</th>
              <th>Balance</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let invoice of filteredInvoices" [class.table-danger]="isOverdue(invoice)">
              <td>
                <strong class="text-primary">{{ invoice.invoiceNumber }}</strong>
              </td>
              <td>
                <div>{{ invoice.patientName }}</div>
                <small class="text-muted">ID: {{ invoice.patientId }}</small>
              </td>
              <td>{{ invoice.invoiceDate | date:'shortDate' }}</td>
              <td>
                <span [class.text-danger]="isOverdue(invoice)">
                  {{ invoice.dueDate | date:'shortDate' }}
                  <i *ngIf="isOverdue(invoice)" class="bi bi-exclamation-circle text-danger ms-1"></i>
                </span>
              </td>
              <td><strong>${{ invoice.totalAmount | number:'1.2-2' }}</strong></td>
              <td class="text-success">${{ invoice.paidAmount | number:'1.2-2' }}</td>
              <td>
                <strong [class.text-danger]="invoice.balanceDue > 0">
                  ${{ invoice.balanceDue | number:'1.2-2' }}
                </strong>
              </td>
              <td>
                <span [class]="getStatusClass(invoice.status)">
                  {{ invoice.status.replace('_', ' ') | titlecase }}
                </span>
              </td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <button 
                    class="btn btn-outline-primary" 
                    (click)="viewInvoice(invoice)"
                    data-bs-toggle="modal" 
                    data-bs-target="#invoiceDetailModal"
                    title="View Details">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button 
                    class="btn btn-outline-info" 
                    (click)="sendInvoice(invoice.id!)"
                    [disabled]="invoice.status === 'SENT' || invoice.status === 'PAID' || invoice.status === 'CANCELLED'"
                    title="Send Invoice">
                    <i class="bi bi-send"></i>
                  </button>
                  <button 
                    class="btn btn-outline-success" 
                    (click)="showAddPaymentModal(invoice)"
                    data-bs-toggle="modal" 
                    data-bs-target="#addPaymentModal"
                    [disabled]="invoice.status === 'PAID' || invoice.status === 'CANCELLED'"
                    title="Add Payment">
                    <i class="bi bi-cash-coin"></i>
                  </button>
                  <button 
                    class="btn btn-outline-warning" 
                    (click)="cancelInvoice(invoice.id!)"
                    [disabled]="invoice.status === 'PAID' || invoice.status === 'CANCELLED'"
                    title="Cancel">
                    <i class="bi bi-x-circle"></i>
                  </button>
                  <button 
                    class="btn btn-outline-danger" 
                    (click)="deleteInvoice(invoice.id!)"
                    title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="filteredInvoices.length === 0">
              <td colspan="9" class="text-center py-4 text-muted">
                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                No invoices found
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <div class="card-footer" *ngIf="totalPages > 1">
      <nav>
        <ul class="pagination pagination-sm mb-0 justify-content-center">
          <li class="page-item" [class.disabled]="currentPage === 0">
            <a class="page-link" (click)="previousPage()" tabindex="-1">Previous</a>
          </li>
          <li 
            class="page-item" 
            *ngFor="let page of pages.slice(Math.max(0, currentPage - 2), Math.min(totalPages, currentPage + 3))"
            [class.active]="page === currentPage">
            <a class="page-link" (click)="goToPage(page)">{{ page + 1 }}</a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
            <a class="page-link" (click)="nextPage()">Next</a>
          </li>
        </ul>
      </nav>
      <div class="text-center mt-2">
        <small class="text-muted">
          Showing {{ currentPage * pageSize + 1 }} to 
          {{ Math.min((currentPage + 1) * pageSize, totalElements) }} of 
          {{ totalElements }} invoices
        </small>
      </div>
    </div>
  </div>
</div>

<!-- Invoice Detail Modal -->
<div class="modal fade" id="invoiceDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-receipt me-2"></i>Invoice Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" *ngIf="selectedInvoice">
        <div class="row mb-4">
          <div class="col-md-6">
            <h6 class="text-primary mb-3">Invoice Information</h6>
            <table class="table table-sm">
              <tr>
                <th width="40%">Invoice #:</th>
                <td><strong>{{ selectedInvoice.invoiceNumber }}</strong></td>
              </tr>
              <tr>
                <th>Invoice Date:</th>
                <td>{{ selectedInvoice.invoiceDate | date:'fullDate' }}</td>
              </tr>
              <tr>
                <th>Due Date:</th>
                <td>
                  <span [class.text-danger]="isOverdue(selectedInvoice)">
                    {{ selectedInvoice.dueDate | date:'fullDate' }}
                  </span>
                </td>
              </tr>
              <tr>
                <th>Status:</th>
                <td>
                  <span [class]="getStatusClass(selectedInvoice.status)">
                    {{ selectedInvoice.status.replace('_', ' ') | titlecase }}
                  </span>
                </td>
              </tr>
            </table>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary mb-3">Patient Information</h6>
            <table class="table table-sm">
              <tr>
                <th width="40%">Name:</th>
                <td>{{ selectedInvoice.patientName }}</td>
              </tr>
              <tr>
                <th>Patient ID:</th>
                <td>{{ selectedInvoice.patientId }}</td>
              </tr>
              <tr *ngIf="selectedInvoice.patientEmail">
                <th>Email:</th>
                <td>{{ selectedInvoice.patientEmail }}</td>
              </tr>
              <tr *ngIf="selectedInvoice.patientPhone">
                <th>Phone:</th>
                <td>{{ selectedInvoice.patientPhone }}</td>
              </tr>
            </table>
          </div>
        </div>

        <div class="row mb-4" *ngIf="selectedInvoice.insuranceProvider">
          <div class="col-12">
            <h6 class="text-primary mb-3">Insurance Information</h6>
            <table class="table table-sm">
              <tr>
                <th width="20%">Provider:</th>
                <td>{{ selectedInvoice.insuranceProvider }}</td>
              </tr>
              <tr>
                <th>Policy #:</th>
                <td>{{ selectedInvoice.insurancePolicyNumber }}</td>
              </tr>
              <tr>
                <th>Claim Amount:</th>
                <td><strong>${{ selectedInvoice.insuranceClaimAmount | number:'1.2-2' }}</strong></td>
              </tr>
            </table>
          </div>
        </div>

        <div class="mb-4">
          <h6 class="text-primary mb-3">Invoice Items</h6>
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Type</th>
                  <th>Description</th>
                  <th>Service Code</th>
                  <th>Qty</th>
                  <th>Unit Price</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of selectedInvoice.items">
                  <td>
                    <span class="badge bg-info">{{ item.itemType.replace('_', ' ') | titlecase }}</span>
                  </td>
                  <td>{{ item.description }}</td>
                  <td>{{ item.serviceCode || 'N/A' }}</td>
                  <td>{{ item.quantity }}</td>
                  <td>${{ item.unitPrice | number:'1.2-2' }}</td>
                  <td><strong>${{ item.totalPrice | number:'1.2-2' }}</strong></td>
                </tr>
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <th colspan="5" class="text-end">Subtotal:</th>
                  <td><strong>${{ selectedInvoice.subtotal | number:'1.2-2' }}</strong></td>
                </tr>
                <tr>
                  <th colspan="5" class="text-end">Tax:</th>
                  <td>${{ selectedInvoice.taxAmount | number:'1.2-2' }}</td>
                </tr>
                <tr>
                  <th colspan="5" class="text-end">Discount:</th>
                  <td class="text-success">-${{ selectedInvoice.discountAmount | number:'1.2-2' }}</td>
                </tr>
                <tr class="table-primary">
                  <th colspan="5" class="text-end">Total Amount:</th>
                  <td><strong>${{ selectedInvoice.totalAmount | number:'1.2-2' }}</strong></td>
                </tr>
                <tr class="table-success">
                  <th colspan="5" class="text-end">Paid Amount:</th>
                  <td><strong>${{ selectedInvoice.paidAmount | number:'1.2-2' }}</strong></td>
                </tr>
                <tr class="table-warning">
                  <th colspan="5" class="text-end">Balance Due:</th>
                  <td><strong>${{ selectedInvoice.balanceDue | number:'1.2-2' }}</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div class="mb-4" *ngIf="selectedInvoice.payments && selectedInvoice.payments.length > 0">
          <h6 class="text-primary mb-3">Payment History</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Reference</th>
                  <th>Method</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Processed By</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let payment of selectedInvoice.payments">
                  <td>{{ payment.paymentDate | date:'short' }}</td>
                  <td>{{ payment.paymentReference || 'N/A' }}</td>
                  <td>{{ payment.paymentMethod.replace('_', ' ') | titlecase }}</td>
                  <td><strong>${{ payment.amount | number:'1.2-2' }}</strong></td>
                  <td>
                    <span class="badge" 
                      [class.bg-success]="payment.status === 'COMPLETED'"
                      [class.bg-warning]="payment.status === 'PENDING'"
                      [class.bg-danger]="payment.status === 'FAILED'">
                      {{ payment.status }}
                    </span>
                  </td>
                  <td>{{ payment.processedBy || 'N/A' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="mb-4" *ngIf="selectedInvoice.notes">
          <h6 class="text-primary mb-3">Notes</h6>
          <p class="border rounded p-3 bg-light">{{ selectedInvoice.notes }}</p>
        </div>

        <div class="row">
          <div class="col-md-4" *ngIf="selectedInvoice.createdAt">
            <small class="text-muted">Created: {{ selectedInvoice.createdAt | date:'short' }}</small>
          </div>
          <div class="col-md-4" *ngIf="selectedInvoice.sentAt">
            <small class="text-muted">Sent: {{ selectedInvoice.sentAt | date:'short' }}</small>
          </div>
          <div class="col-md-4" *ngIf="selectedInvoice.paidAt">
            <small class="text-success">Paid: {{ selectedInvoice.paidAt | date:'short' }}</small>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="window.print()">
          <i class="bi bi-printer me-2"></i>Print
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-cash-coin me-2"></i>Add Payment
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <app-payment-form 
          *ngIf="selectedInvoice" 
          [invoice]="selectedInvoice"
          (paymentAdded)="onPaymentAdded()">
        </app-payment-form>
      </div>
    </div>
  </div>
</div>
