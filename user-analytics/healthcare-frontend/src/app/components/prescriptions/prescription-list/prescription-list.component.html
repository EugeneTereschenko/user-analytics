<div class="container-fluid py-4">
  <div class="row mb-3">
    <div class="col">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a routerLink="/dashboard" class="text-decoration-none"><i class="bi bi-house-door me-1"></i>Dashboard</a></li>
          <li class="breadcrumb-item active" aria-current="page">Prescriptions</li>
        </ol>
      </nav>
    </div>
  </div>
  <div class="row mb-4">
    <div class="col">
      <h2 class="mb-0">
        <i class="bi bi-prescription2 me-2"></i>Prescription Management
      </h2>
    </div>
    <div class="col-auto">
      <button class="btn btn-primary" routerLink="/prescriptions/create">
        <i class="bi bi-plus-circle me-2"></i>New Prescription
      </button>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Search</label>
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input 
              type="text" 
              class="form-control" 
              placeholder="Search prescriptions..."
              [(ngModel)]="searchQuery"
              (keyup.enter)="searchPrescriptions()">
            <button class="btn btn-outline-primary" (click)="searchPrescriptions()">
              Search
            </button>
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Status Filter</label>
          <select 
            class="form-select" 
            [(ngModel)]="statusFilter"
            (change)="filterByStatus()">
            <option value="ALL">All Statuses</option>
            <option *ngFor="let status of prescriptionStatuses" [value]="status">
              {{ status }}
            </option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Patient ID</label>
          <input 
            type="number" 
            class="form-control" 
            placeholder="Patient ID"
            [(ngModel)]="patientIdFilter"
            (change)="filterByPatient()">
        </div>

        <div class="col-md-3">
          <label class="form-label">&nbsp;</label>
          <div class="d-grid gap-2 d-md-flex">
            <button class="btn btn-outline-secondary" (click)="loadPrescriptions()">
              <i class="bi bi-arrow-clockwise me-1"></i>Reset
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ error }}
    <button type="button" class="btn-close" (click)="error = null"></button>
  </div>

  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div *ngIf="!isLoading" class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Prescription #</th>
              <th>Patient</th>
              <th>Doctor</th>
              <th>Date</th>
              <th>Valid Until</th>
              <th>Medications</th>
              <th>Status</th>
              <th>Refills</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let prescription of filteredPrescriptions">
              <td>
                <strong class="text-primary">{{ prescription.prescriptionNumber }}</strong>
              </td>
              <td>
                <div>{{ prescription.patientName }}</div>
                <small class="text-muted">ID: {{ prescription.patientId }}</small>
              </td>
              <td>
                <div>{{ prescription.doctorName }}</div>
                <small class="text-muted">Lic: {{ prescription.doctorLicense }}</small>
              </td>
              <td>{{ prescription.prescriptionDate | date:'short' }}</td>
              <td>
                <span [class.text-danger]="isExpired(prescription.validUntil)">
                  {{ prescription.validUntil | date:'short' }}
                </span>
              </td>
              <td>
                <span class="badge bg-primary">
                  {{ prescription.medications.length || 0 }} med(s)
                </span>
              </td>
              <td>
                <span [class]="getStatusClass(prescription.status)">
                  {{ prescription.status }}
                </span>
              </td>
              <td>
                <small *ngIf="prescription.isRefillable">
                  {{ prescription.refillsRemaining }}/{{ prescription.refillsAllowed }}
                </small>
                <small *ngIf="!prescription.isRefillable" class="text-muted">N/A</small>
              </td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <button 
                    class="btn btn-outline-primary" 
                    (click)="viewPrescription(prescription)"
                    data-bs-toggle="modal" 
                    data-bs-target="#prescriptionDetailModal"
                    title="View Details">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button 
                    class="btn btn-outline-success" 
                    (click)="dispensePrescription(prescription.id!)"
                    [disabled]="prescription.status !== 'ACTIVE'"
                    title="Dispense">
                    <i class="bi bi-check-circle"></i>
                  </button>
                  <button 
                    class="btn btn-outline-info" 
                    (click)="refillPrescription(prescription.id!)"
                    [disabled]="!prescription.isRefillable || prescription.refillsRemaining! <= 0"
                    title="Refill">
                    <i class="bi bi-arrow-repeat"></i>
                  </button>
                  <button 
                    class="btn btn-outline-warning" 
                    (click)="cancelPrescription(prescription.id!)"
                    [disabled]="prescription.status === 'CANCELLED'"
                    title="Cancel">
                    <i class="bi bi-x-circle"></i>
                  </button>
                  <button 
                    class="btn btn-outline-danger" 
                    (click)="deletePrescription(prescription.id!)"
                    title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="filteredPrescriptions.length === 0">
              <td colspan="9" class="text-center py-4 text-muted">
                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                No prescriptions found
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card-footer" *ngIf="totalPages > 1">
      <nav>
        <ul class="pagination pagination-sm mb-0 justify-content-center">
          <li class="page-item" [class.disabled]="currentPage === 0">
            <a class="page-link" (click)="previousPage()" tabindex="-1">Previous</a>
          </li>
          <li 
            class="page-item" 
            *ngFor="let page of pages.slice(Math.max(0, currentPage - 2), Math.min(totalPages, currentPage + 3))"
            [class.active]="page === currentPage">
            <a class="page-link" (click)="goToPage(page)">{{ page + 1 }}</a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
            <a class="page-link" (click)="nextPage()">Next</a>
          </li>
        </ul>
      </nav>
      <div class="text-center mt-2">
        <small class="text-muted">
          Showing {{ currentPage * pageSize + 1 }} to 
          {{ Math.min((currentPage + 1) * pageSize, totalElements) }} of 
          {{ totalElements }} prescriptions
        </small>
      </div>
    </div>
  </div>
</div>

<!-- Prescription Detail Modal -->
<div class="modal fade" id="prescriptionDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-file-medical me-2"></i>Prescription Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" *ngIf="selectedPrescription">
        <div class="row mb-4">
          <div class="col-md-6">
            <h6 class="text-primary mb-3">Prescription Information</h6>
            <table class="table table-sm">
              <tr>
                <th width="40%">Prescription #:</th>
                <td>{{ selectedPrescription.prescriptionNumber }}</td>
              </tr>
              <tr>
                <th>Date Issued:</th>
                <td>{{ selectedPrescription.prescriptionDate | date:'fullDate' }}</td>
              </tr>
              <tr>
                <th>Valid Until:</th>
                <td>{{ selectedPrescription.validUntil | date:'fullDate' }}</td>
              </tr>
              <tr>
                <th>Status:</th>
                <td>
                  <span [class]="getStatusClass(selectedPrescription.status)">
                    {{ selectedPrescription.status }}
                  </span>
                </td>
              </tr>
            </table>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary mb-3">Patient Information</h6>
            <table class="table table-sm">
              <tr>
                <th width="40%">Name:</th>
                <td>{{ selectedPrescription.patientName }}</td>
              </tr>
              <tr>
                <th>Patient ID:</th>
                <td>{{ selectedPrescription.patientId }}</td>
              </tr>
              <tr>
                <th>Date of Birth:</th>
                <td>{{ selectedPrescription.patientDateOfBirth | date:'mediumDate' }}</td>
              </tr>
            </table>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-6">
            <h6 class="text-primary mb-3">Prescriber Information</h6>
            <table class="table table-sm">
              <tr>
                <th width="40%">Doctor:</th>
                <td>{{ selectedPrescription.doctorName }}</td>
              </tr>
              <tr>
                <th>License #:</th>
                <td>{{ selectedPrescription.doctorLicense }}</td>
              </tr>
              <tr>
                <th>Doctor ID:</th>
                <td>{{ selectedPrescription.doctorId }}</td>
              </tr>
            </table>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary mb-3">Pharmacy Information</h6>
            <table class="table table-sm">
              <tr>
                <th width="40%">Pharmacy:</th>
                <td>{{ selectedPrescription.pharmacyName || 'N/A' }}</td>
              </tr>
              <tr>
                <th>Address:</th>
                <td>{{ selectedPrescription.pharmacyAddress || 'N/A' }}</td>
              </tr>
            </table>
          </div>
        </div>

        <div class="mb-4" *ngIf="selectedPrescription.diagnosis">
          <h6 class="text-primary mb-3">Diagnosis</h6>
          <p class="border rounded p-3 bg-light">{{ selectedPrescription.diagnosis }}</p>
        </div>

        <div class="mb-4">
          <h6 class="text-primary mb-3">Medications</h6>
          <div class="accordion" id="medicationsAccordion">
            <div 
              class="accordion-item" 
              *ngFor="let med of selectedPrescription.medications; let i = index">
              <h2 class="accordion-header">
                <button 
                  class="accordion-button" 
                  [class.collapsed]="i !== 0"
                  type="button" 
                  data-bs-toggle="collapse" 
                  [attr.data-bs-target]="'#collapse' + i">
                  <strong>{{ med.medicationName }}</strong>
                  <span class="badge bg-secondary ms-2">{{ med.dosage }}</span>
                  <span class="badge bg-info ms-2">{{ med.frequency }}</span>
                </button>
              </h2>
              <div 
                [id]="'collapse' + i" 
                class="accordion-collapse collapse" 
                [class.show]="i === 0"
                data-bs-parent="#medicationsAccordion">
                <div class="accordion-body">
                  <div class="row">
                    <div class="col-md-6">
                      <table class="table table-sm">
                        <tr *ngIf="med.genericName">
                          <th width="40%">Generic Name:</th>
                          <td>{{ med.genericName }}</td>
                        </tr>
                        <tr>
                          <th>Dosage Form:</th>
                          <td>{{ med.dosageForm || 'N/A' }}</td>
                        </tr>
                        <tr>
                          <th>Strength:</th>
                          <td>{{ med.strength || 'N/A' }}</td>
                        </tr>
                        <tr>
                          <th>Route:</th>
                          <td>{{ med.route }}</td>
                        </tr>
                        <tr>
                          <th>Duration:</th>
                          <td>{{ med.duration || 'N/A' }}</td>
                        </tr>
                      </table>
                    </div>
                    <div class="col-md-6">
                      <table class="table table-sm">
                        <tr>
                          <th width="40%">Quantity:</th>
                          <td>{{ med.quantity }} {{ med.unit }}</td>
                        </tr>
                        <tr>
                          <th>Start Date:</th>
                          <td>{{ med.startDate | date:'mediumDate' }}</td>
                        </tr>
                        <tr>
                          <th>End Date:</th>
                          <td>{{ med.endDate | date:'mediumDate' }}</td>
                        </tr>
                        <tr>
                          <th>Generic Allowed:</th>
                          <td>
                            <span class="badge" [class.bg-success]="med.isGenericAllowed" [class.bg-danger]="!med.isGenericAllowed">
                              {{ med.isGenericAllowed ? 'Yes' : 'No' }}
                            </span>
                          </td>
                        </tr>
                        <tr *ngIf="med.isControlledSubstance">
                          <th>Controlled:</th>
                          <td><span class="badge bg-warning text-dark">Yes</span></td>
                        </tr>
                      </table>
                    </div>
                  </div>
                  <div class="row mt-3" *ngIf="med.instructions">
                    <div class="col-12">
                      <h6 class="text-secondary">Instructions</h6>
                      <p class="border rounded p-2 bg-light">{{ med.instructions }}</p>
                    </div>
                  </div>
                  <div class="row" *ngIf="med.warnings || med.sideEffects">
                    <div class="col-md-6" *ngIf="med.warnings">
                      <h6 class="text-warning">Warnings</h6>
                      <p class="border border-warning rounded p-2 bg-warning bg-opacity-10">
                        {{ med.warnings }}
                      </p>
                    </div>
                    <div class="col-md-6" *ngIf="med.sideEffects">
                      <h6 class="text-info">Side Effects</h6>
                      <p class="border border-info rounded p-2 bg-info bg-opacity-10">
                        {{ med.sideEffects }}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-4" *ngIf="selectedPrescription.isRefillable">
          <h6 class="text-primary mb-3">Refill Information</h6>
          <div class="alert alert-info">
            <i class="bi bi-arrow-repeat me-2"></i>
            Refills Remaining: <strong>{{ selectedPrescription.refillsRemaining }}</strong> / 
            {{ selectedPrescription.refillsAllowed }}
          </div>
        </div>

        <div class="mb-4" *ngIf="selectedPrescription.notes">
          <h6 class="text-primary mb-3">Additional Notes</h6>
          <p class="border rounded p-3 bg-light">{{ selectedPrescription.notes }}</p>
        </div>

        <div class="mb-4" *ngIf="selectedPrescription.dispensedAt">
          <h6 class="text-primary mb-3">Dispensing Information</h6>
          <table class="table table-sm">
            <tr>
              <th width="20%">Dispensed At:</th>
              <td>{{ selectedPrescription.dispensedAt | date:'full' }}</td>
            </tr>
            <tr>
              <th>Dispensed By:</th>
              <td>{{ selectedPrescription.dispensedBy }}</td>
            </tr>
          </table>
        </div>

        <div class="mb-4" *ngIf="selectedPrescription.cancelledAt">
          <div class="alert alert-danger">
            <h6 class="alert-heading">Cancellation Information</h6>
            <p class="mb-1"><strong>Cancelled At:</strong> {{ selectedPrescription.cancelledAt | date:'full' }}</p>
            <p class="mb-0" *ngIf="selectedPrescription.cancellationReason">
              <strong>Reason:</strong> {{ selectedPrescription.cancellationReason }}
            </p>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <small class="text-muted">Created: {{ selectedPrescription.createdAt | date:'short' }}</small>
          </div>
          <div class="col-md-6 text-end">
            <small class="text-muted">Updated: {{ selectedPrescription.updatedAt | date:'short' }}</small>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="window.print()">
          <i class="bi bi-printer me-2"></i>Print
        </button>
      </div>
    </div>
  </div>
</div>
